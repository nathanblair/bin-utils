#!/bin/bash

backlight_path=/sys/class/backlight
device_name=${2:-$(ls $backlight_path | head -1)}
max_brightness=$(cat $backlight_path/$device_name/max_brightness 2>/dev/null)

# Check that a maximum brightness could be obtained
: ${max_brightness:?Could not get max brightness of device!}

current_brightness=$(cat $backlight_path/$device_name/brightness 2>/dev/null)

# Print the raw number if no arguments given
[[ -z $1 ]] && echo $current_brightness && exit 0
# Print the current brightness in percent if argument given is a '%' sign
[[ $1 == '%' ]] && printf '%.0f%%\n' \
    $( echo "$current_brightness / $max_brightness * 100" | bc -l) \
    && exit 0

# Extract mods from string and apply them if applicable
setting=$1
[[ ${1: -1} == '%' ]] && setting=${1%\%} && \
    setting=$( echo "${setting#+} / 100 * $max_brightness" | bc -l )
[[ ${1:0:1} == '+' || ${1:0:1} == '-' ]] && \
    setting=$( echo "${setting#+} + $current_brightness" | bc -l )

[[ $(echo "$setting <= 0" | bc -l) == 1 ]] && setting=1
[[ $(echo "$setting > $max_brightness" | bc -l) == 1 ]] && setting=$max_brightness

# Set the brightness
echo $(printf '%.0f' $setting) \
    > /sys/class/backlight/$device_name/brightness

# Exit with whether setting the brightness was successful
exit $?

